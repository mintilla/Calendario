<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Torres de Elorz 2026</title>
    <style>
        :root {
            --festivo: #FFD700;
            --puente: #4FC3F7;
            --vacacional: #FFB74D;
            --previo: #81C784;
            --personal-bg: #fce4ec;
            --personal-border: #e91e63;
            --viaje-color: #E1BEE7;  /* MORADO para viajes */
            --viaje-borde: #9C27B0;  /* Borde morado */
            --weekend: #e0e0e0;
            --text-light: #666;
            --text-dark: #333;
            --shadow: 0 10px 30px rgba(0,0,0,0.15);
            --card-bg: #ffffff;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 8px;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow);
        }
        
        h1 {
            text-align: center;
            color: var(--text-dark);
            margin-bottom: 10px;
            font-size: 18px;
            line-height: 1.3;
        }
        
        .legend {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin: 12px 0;
            font-size: 9px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .legend-color {
            flex-shrink: 0;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid #ddd;
        }
        
        /* Vistas */
        #vistaCalendario {
            display: block;
        }
        
        #vistaViajes, #formularioViaje {
            display: none;
        }
        
        .boton-principal {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            text-align: center;
            margin: 15px 0;
        }
        
        .boton-principal:hover {
            transform: scale(1.02);
        }
        
        .months-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .months-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .month {
            background: #fafafa;
            border-radius: 6px;
            padding: 6px;
            min-width: 0;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .month:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .month-header {
            text-align: center;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 4px;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: 18px repeat(7, 1fr);
            gap: 1px;
            font-size: 9px;
        }
        
        .week-header,
        .day-header {
            text-align: center;
            font-weight: bold;
            color: var(--text-light);
            padding: 2px 1px;
            font-size: 8px;
        }
        
        .week-number {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            color: #999;
            font-weight: bold;
            padding: 2px 0;
        }
        
        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            position: relative;
            border: 1px solid transparent;
            user-select: none;
            min-height: 0;
            min-width: 0;
        }
        
        /* VIAJES EN MORADO */
        .day.tiene-viaje {
            background: var(--viaje-color) !important;
            border: 1px solid var(--viaje-borde) !important;
        }
        
        .day.empty {
            cursor: default;
            background: transparent;
            visibility: hidden;
        }
        
        .day.festivo {
            background: var(--festivo);
            color: var(--text-dark);
            font-weight: bold;
        }
        
        .day.puente {
            background: var(--puente);
            color: white;
            font-weight: bold;
        }
        
        .day.vacacional {
            background: var(--vacacional);
            color: white;
        }
        
        .day.previo {
            background: var(--previo);
            color: white;
        }
        
        .day.personal {
            background: var(--personal-bg) !important;
            border: 2px solid var(--personal-border) !important;
            color: var(--text-dark) !important;
            font-weight: bold;
        }
        
        .day.weekend {
            background: var(--weekend);
            color: var(--text-light);
        }
        
        /* Modal para vista ampliada */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            max-width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-dark);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            background: #f5f5f5;
        }
        
        /* Estilos para la vista modal */
        .modal-calendar {
            width: 100%;
            overflow-x: auto;
        }
        
        .modal-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            width: 100%;
            min-width: 0;
        }
        
        .modal-week-header {
            text-align: center;
            font-weight: bold;
            padding: 12px 6px;
            font-size: 12px;
            color: var(--text-light);
            background: #f8f9fa;
            border-radius: 6px;
            min-width: 0;
        }
        
        .modal-day-header {
            text-align: center;
            font-weight: bold;
            padding: 12px 6px;
            font-size: 14px;
            color: var(--text-dark);
            background: #f8f9fa;
            border-radius: 6px;
            min-width: 0;
        }
        
        .modal-week-number {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
            font-weight: bold;
            padding: 12px 6px;
            background: #f8f9fa;
            border-radius: 6px;
            min-width: 0;
        }
        
        .modal-day {
            width: 100%;
            min-height: 0;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s ease;
            user-select: none;
            padding: 2px;
            min-width: 0;
            position: relative;
        }
        
        .modal-day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .modal-day.empty {
            background: transparent;
            border: none;
            cursor: default;
            visibility: hidden;
        }
        
        .modal-day.festivo {
            background: var(--festivo);
            color: var(--text-dark);
            font-weight: bold;
        }
        
        .modal-day.puente {
            background: var(--puente);
            color: white;
            font-weight: bold;
        }
        
        .modal-day.vacacional {
            background: var(--vacacional);
            color: white;
        }
        
        .modal-day.previo {
            background: var(--previo);
            color: white;
        }
        
        .modal-day.personal {
            background: var(--personal-bg) !important;
            border: 2px solid var(--personal-border) !important;
            color: var(--text-dark) !important;
            font-weight: bold;
        }
        
        .modal-day.weekend {
            background: var(--weekend);
            color: var(--text-light);
        }
        
        /* VIAJES EN MODAL - MORADO */
        .modal-day.tiene-viaje {
            background: var(--viaje-color) !important;
            border: 2px solid var(--viaje-borde) !important;
        }
        
        /* Info del d√≠a (popup) */
        .day-info-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .day-info-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .day-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .day-info-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
        }
        
        .close-day-info {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-day-info:hover {
            background: #f5f5f5;
        }
        
        .day-info-body {
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 6px;
            background: #f9f9f9;
        }
        
        .info-icon {
            font-size: 18px;
            width: 30px;
            text-align: center;
        }
        
        .info-text {
            flex: 1;
            font-size: 14px;
        }
        
        .info-viaje {
            background: #f3e5f5;
            border-left: 4px solid var(--viaje-borde);
        }
        
        .info-personal {
            background: #fce4ec;
            border-left: 4px solid var(--personal-border);
        }
        
        .info-festivo {
            background: #fffde7;
            border-left: 4px solid var(--festivo);
        }
        
        .info-puente {
            background: #e3f2fd;
            border-left: 4px solid var(--puente);
        }
        
        .info-vacacional {
            background: #fff3e0;
            border-left: 4px solid var(--vacacional);
        }
        
        .info-previo {
            background: #e8f5e9;
            border-left: 4px solid var(--previo);
        }
        
        /* Gesti√≥n de viajes */
        .viajes-container {
            display: none;
        }
        
        .viajes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .volver-calendario {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-light);
            padding: 8px;
        }
        
        .lista-viajes {
            margin-top: 15px;
        }
        
        .viaje-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--viaje-borde);
        }
        
        .viaje-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .viaje-destino-card {
            font-weight: bold;
            color: var(--text-dark);
            font-size: 14px;
        }
        
        .viaje-acciones {
            display: flex;
            gap: 8px;
        }
        
        .btn-editar {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            border-radius: 4px;
            color: #2196F3;
        }
        
        .viaje-cliente-card {
            color: var(--text-light);
            font-size: 12px;
            margin-bottom: 6px;
        }
        
        .viaje-fechas {
            color: var(--text-dark);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-nuevo-viaje {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
            margin-top: 15px;
        }
        
        /* Formularios */
        .formulario-viaje {
            display: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-dark);
            font-size: 14px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='https://eur02.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg&data=05%7C02%7CMikel.Intillaque%40mtorres.com%7Cb42b0cc2be8949d1330d08de55a0ce34%7C20ff5489ede44fb8a9c87f5aad56f6da%7C0%7C0%7C639042346309464134%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=ZlICX3mgjEYnnJarTu8KeuYGQepQkXExl96SjFe0%2FF8%3D&reserved=0' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }
        
        .form-botones {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-guardar {
            flex: 1;
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-cancelar {
            flex: 1;
            background: #f5f5f5;
            color: var(--text-dark);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* BOT√ìN ELIMINAR EN FORMULARIO */
        .btn-eliminar-viaje {
            width: 100%;
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* MODAL DE CONFIRMACI√ìN PERSONALIZADO */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .confirm-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .confirm-modal-title {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .confirm-modal-message {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            line-height: 1.4;
        }
        
        .confirm-modal-buttons {
            display: flex;
            gap: 10px;
        }
        
        .confirm-btn-cancel {
            flex: 1;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .confirm-btn-delete {
            flex: 1;
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        /* SECCI√ìN BACKUP */
        .backup-section {
            margin-top: 30px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        
        .backup-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .backup-description {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .backup-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        
        .backup-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .btn-exportar {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        
        .btn-importar {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        
        .backup-note {
            text-align: center;
            margin-top: 10px;
            font-size: 11px;
            color: #999;
        }

        /* MODAL DE BACKUP */
        .backup-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .backup-modal-stats {
            margin: 15px 0;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        
        .backup-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .backup-option-btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: bold;
        }
        
        .btn-copy {
            background: #4CAF50;
            color: white;
        }
        
        .btn-share {
            background: #2196F3;
            color: white;
        }
        
        .btn-view {
            background: #FF9800;
            color: white;
        }
        
        .btn-cancel {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        /* MODAL IMPORTACI√ìN iOS SHORTCUTS */
        .ios-import-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .ios-import-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .ios-import-title {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        
        .ios-textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px dashed #9C27B0;
            border-radius: 8px;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 12px;
            margin-bottom: 15px;
            resize: none;
            background: #fafafa;
        }
        
        .ios-textarea::placeholder {
            color: #9C27B0;
            opacity: 0.7;
        }
        
        .ios-import-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-ios-import {
            flex: 1;
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-ios-cancel {
            flex: 1;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Optimizaciones para iPhone */
        @media only screen and (max-width: 428px) {
            body {
                padding: 6px;
            }
            
            .container {
                padding: 10px;
                border-radius: 10px;
            }
            
            h1 {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .months-row {
                gap: 6px;
            }
            
            .month {
                padding: 5px;
            }
            
            .calendar-grid {
                grid-template-columns: 16px repeat(7, 1fr);
                gap: 0.5px;
            }
            
            .day {
                font-size: 8px;
                border-radius: 2px;
            }
            
            .legend {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
                font-size: 8px;
            }
            
            .modal-content {
                padding: 10px;
            }
            
            .modal-grid {
                gap: 3px;
            }
            
            .modal-day {
                font-size: 13px;
                border-radius: 6px;
            }
            
            .modal-title {
                font-size: 18px;
            }
            
            .modal-day-header,
            .modal-week-header,
            .modal-week-number {
                padding: 10px 4px;
                font-size: 11px;
                border-radius: 4px;
            }
            
            .viaje-card {
                padding: 10px;
            }
            
            .form-input, .form-select {
                padding: 8px;
                font-size: 13px;
            }
            
            .day-info-content {
                padding: 15px;
            }
            
            .info-item {
                padding: 6px;
                margin-bottom: 8px;
            }
            
            .confirm-modal-content {
                padding: 15px;
                max-width: 280px;
            }
            
            .backup-section {
                padding: 12px;
                margin-top: 20px;
            }
            
            .backup-stats {
                padding: 8px;
            }
            
            .stat-number {
                font-size: 16px;
            }
            
            .backup-modal-content {
                padding: 15px;
                max-width: 320px;
            }
            
            .ios-import-content {
                padding: 15px;
                max-width: 320px;
            }
            
            .ios-textarea {
                height: 180px;
                font-size: 11px;
            }
        }

        @media only screen and (max-width: 375px) {
            .modal-day {
                font-size: 12px;
            }
            
            .calendar-grid {
                grid-template-columns: 14px repeat(7, 1fr);
            }
            
            .day {
                font-size: 7px;
            }
            
            .month-header {
                font-size: 10px;
            }
            
            .modal-day-header,
            .modal-week-header,
            .modal-week-number {
                font-size: 10px;
                padding: 8px 3px;
            }
            
            .backup-title {
                font-size: 13px;
            }
        }

        @media only screen and (min-width: 768px) {
            .container {
                max-width: 768px;
                padding: 20px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .months-row {
                gap: 12px;
            }
            
            .month {
                padding: 10px;
            }
            
            .calendar-grid {
                gap: 2px;
            }
            
            .day {
                font-size: 11px;
            }
            
            .legend {
                grid-template-columns: repeat(6, auto);
                justify-content: center;
                font-size: 10px;
                gap: 12px;
            }
            
            .modal-content {
                max-width: 520px;
                padding: 20px;
            }
            
            .modal-grid {
                gap: 5px;
            }
            
            .modal-day {
                font-size: 15px;
            }
            
            .backup-section {
                max-width: 500px;
                margin: 30px auto 0;
            }
            
            .backup-buttons {
                flex-direction: row;
            }
            
            .btn-exportar, .btn-importar {
                flex: 1;
            }
        }
    
/* --- Botones principales en paralelo --- */
.botones-principales{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:560px){.botones-principales{grid-template-columns:1fr 1fr}}

</style>
  <link rel="stylesheet" href="./world/mapa.css">
</head>
<body>
    <div class="container">
        <!-- VISTA PRINCIPAL DEL CALENDARIO -->
        <div id="vistaCalendario">
            <h1>üìÖ Calendario Laboral Torres de Elorz 2026</h1>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--festivo);"></div>
                    <span>Festivo</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--puente);"></div>
                    <span>Puente/Ajuste</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--vacacional);"></div>
                    <span>Vacacional</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--previo);"></div>
                    <span>Previo 6h</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--personal-bg); border: 2px solid var(--personal-border);"></div>
                    <span>Mis vacaciones</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--viaje-color); border: 1px solid var(--viaje-borde);"></div>
                    <span>‚úàÔ∏è Mis viajes</span>
                </div>
            </div>
            
            <!-- SOLO UN BOT√ìN: MIS VIAJES -->
            <div class="botones-principales">
  <button class="boton-principal" id="btnMisViajes">‚úàÔ∏è MIS VIAJES</button>
  <button class="boton-principal" id="btnMapaMundial">üåç MAPA MUNDIAL</button>
</div>
            
            <!-- Calendario -->
            <div class="months-container" id="calendar"></div>
            
            <!-- SECCI√ìN BACKUP -->
            <div class="backup-section">
                <h3 class="backup-title">üìÅ Copia de seguridad</h3>
                <p class="backup-description">
                    Exporta tus datos para guardarlos en un lugar seguro o restaurarlos en otro dispositivo
                </p>
                
                <div class="backup-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="statViajes">0</div>
                        <div class="stat-label">Viajes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="statVacaciones">0</div>
                        <div class="stat-label">D√≠as vacaciones</div>
                    </div>
                </div>
                
                <div class="backup-buttons">
                    <button class="btn-exportar" id="btnExportar">
                        üíæ EXPORTAR BACKUP
                    </button>
                    <button class="btn-importar" id="btnImportar">
                        üìÇ IMPORTAR DESDE ARCHIVO
                    </button>
                    <button class="btn-importar" id="btnImportarIOS" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
                        üìù PEGAR BACKUP (iOS Shortcuts)
                    </button>
                </div>
                
                <input type="file" id="fileImport" accept=".json" style="display: none;">
                
                <p class="backup-note">
                    Tus datos se guardan autom√°ticamente en este dispositivo
                </p>
            </div>
        </div>
        
        <!-- VISTA DE GESTI√ìN DE VIAJES -->
        <div class="viajes-container" id="vistaViajes">
            <div class="viajes-header">
                <button class="volver-calendario" id="volverCalendario">‚Üê Volver</button>
                <h2>‚úàÔ∏è Mis Viajes 2026</h2>
                <div></div>
            </div>
            
            <div class="lista-viajes" id="listaViajes">
                <!-- Los viajes se cargar√°n aqu√≠ din√°micamente -->
            </div>
            
            <button class="btn-nuevo-viaje" id="btnNuevoViaje">
                Ôºã A√ëADIR NUEVO VIAJE
            </button>
        </div>
        
        <!-- FORMULARIO DE NUEVO/EDITAR VIAJE -->
        <div class="formulario-viaje" id="formularioViaje">
            <div class="viajes-header">
                <button class="volver-calendario" id="volverListaViajes">‚Üê Cancelar</button>
                <h2 id="tituloFormulario">NUEVO VIAJE</h2>
                <div></div>
            </div>
            
            <form id="formViaje">
                <input type="hidden" id="viajeId">
                
                <div class="form-group">
                    <label class="form-label" for="pais">üåç Pa√≠s destino:</label>
                    <select class="form-select" id="pais" required>
                        <option value="">Selecciona un pa√≠s</option>
                        <!-- Los pa√≠ses se cargar√°n din√°micamente -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="ciudadDestino">üìç Ciudad destino (opcional):</label>
                    <input type="text" class="form-input" id="ciudadDestino" placeholder="Ej: Par√≠s, Frankfurt, Londres">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="fechaInicio">üìÖ Fecha inicio:</label>
                    <input type="date" class="form-input" id="fechaInicio" required min="2026-01-01" max="2026-12-31">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="fechaFin">üìÖ Fecha fin:</label>
                    <input type="date" class="form-input" id="fechaFin" required min="2026-01-01" max="2026-12-31">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="cliente">üë§ Cliente:</label>
                    <input type="text" class="form-input" id="cliente" required placeholder="Ej: Airbus, Siemens, Rolls-Royce">
                </div>
                
                <div class="form-botones">
                    <button type="button" class="btn-cancelar" id="cancelarViaje">Cancelar</button>
                    <button type="submit" class="btn-guardar" id="guardarViaje">GUARDAR VIAJE</button>
                </div>
                
                <!-- BOT√ìN ELIMINAR (solo visible al editar) -->
                <button type="button" class="btn-eliminar-viaje" id="btnEliminarViaje" style="display: none;">
                    üóëÔ∏è ELIMINAR VIAJE
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal para vista ampliada del calendario -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ENERO 2026</div>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-calendar" id="modalCalendar"></div>
            <!-- Bot√≥n para gestionar vacaciones en esta vista -->
            <button class="btn-nuevo-viaje" id="btnToggleVacaciones" style="margin-top: 15px; background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);">
                üèñÔ∏è MARCAR/DESMARCAR VACACIONES
            </button>
        </div>
    </div>
    
    <!-- Popup para informaci√≥n del d√≠a -->
    <div class="day-info-overlay" id="dayInfoOverlay">
        <div class="day-info-content">
            <div class="day-info-header">
                <div class="day-info-title" id="dayInfoTitle">15 de Enero 2026</div>
                <button class="close-day-info" id="closeDayInfo">&times;</button>
            </div>
            <div class="day-info-body" id="dayInfoBody">
                <!-- Informaci√≥n del d√≠a se cargar√° aqu√≠ -->
            </div>
            <div class="form-botones">
                <button class="btn-cancelar" id="closeDayInfoBtn">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para importaci√≥n iOS Shortcuts -->
    <div class="ios-import-overlay" id="iosImportOverlay">
        <div class="ios-import-content">
            <h3 class="ios-import-title">üìù IMPORTAR DESDE iOS SHORTCUTS</h3>
            <textarea class="ios-textarea" id="iosImportTextarea" 
                placeholder="Pega aqu√≠ el backup copiado previamente..."></textarea>
            <div class="ios-import-buttons">
                <button class="btn-ios-cancel" id="iosCancelBtn">‚ùå Cancelar</button>
                <button class="btn-ios-import" id="iosImportBtn">‚úÖ IMPORTAR</button>
            </div>
        </div>
    </div>

    <script>
        class CalendarioViajes {
            constructor() {
                this.meses = [
                    'ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 
                    'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'
                ];
                
                this.diasSemana = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
                
                // D√çAS ESPECIALES
                this.diasEspeciales = {
                    festivos: new Set([
                        '2026-01-01', '2026-01-06', '2026-03-19', '2026-04-02', '2026-04-03', 
                        '2026-04-06', '2026-05-01', '2026-08-15', '2026-10-12', '2026-11-02', 
                        '2026-12-03', '2026-12-08', '2026-12-25'
                    ]),
                    puentes: new Set([
                        '2026-01-02', '2026-03-20', '2026-04-07', '2026-12-04', 
                        '2026-12-07', '2026-12-24', '2026-12-28', '2026-12-29', 
                        '2026-12-30', '2026-12-31'
                    ]),
                    vacacionales: new Set([
                        '2026-02-01', '2026-02-08', '2026-03-01', '2026-03-08',
                        '2026-04-05', '2026-05-01', '2026-07-06', '2026-07-07', 
                        '2026-07-08', '2026-07-09', '2026-07-10', '2026-07-11', 
                        '2026-07-12', '2026-07-13', '2026-07-14', '2026-08-01', 
                        '2026-08-02', '2026-08-08', '2026-08-09', '2026-08-15', 
                        '2026-08-16', '2026-08-22', '2026-08-23', '2026-11-01', 
                        '2026-12-03', '2026-12-04', '2026-12-24', '2026-12-25', 
                        '2026-12-31'
                    ]),
                    previos: new Set([
                        '2026-12-23'  // 23.12 - √öNICO d√≠a de 6h
                    ])
                };
                
                // LISTA DE PA√çSES COMPLETA (180 pa√≠ses)
                this.paises = [
                    // Europa
                    "Alemania", "Austria", "B√©lgica", "Bulgaria", "Chipre", "Croacia",
                    "Dinamarca", "Eslovaquia", "Eslovenia", "Espa√±a", "Estonia",
                    "Finlandia", "Francia", "Grecia", "Hungr√≠a", "Irlanda", "Italia",
                    "Letonia", "Lituania", "Luxemburgo", "Malta", "Pa√≠ses Bajos",
                    "Polonia", "Portugal", "Rep√∫blica Checa", "Ruman√≠a", "Suecia",
                    "Reino Unido", "Suiza", "Noruega", "Islandia", "Rusia", "Turqu√≠a",
                    
                    // Asia
                    "Afganist√°n", "Arabia Saudita", "Armenia", "Azerbaiy√°n", "Banglad√©s",
                    "Bar√©in", "Birmania (Myanmar)", "Brunei", "But√°n", "Camboya",
                    "Catar", "China", "Corea del Norte", "Corea del Sur", "Emiratos √Årabes Unidos",
                    "Filipinas", "Georgia", "India", "Indonesia", "Irak", "Ir√°n",
                    "Israel", "Jap√≥n", "Jordania", "Kazajist√°n", "Kirguist√°n",
                    "Kuwait", "Laos", "L√≠bano", "Malasia", "Maldivas", "Mongolia",
                    "Nepal", "Om√°n", "Pakist√°n", "Palestina", "Singapur", "Siria",
                    "Sri Lanka", "Tailandia", "Taiw√°n", "Tayikist√°n", "Timor Oriental",
                    "Turkmenist√°n", "Uzbekist√°n", "Vietnam", "Yemen",
                    
                    // Am√©rica
                    "Argentina", "Bahamas", "Barbados", "Belice", "Bolivia", "Brasil",
                    "Canad√°", "Chile", "Colombia", "Costa Rica", "Cuba", "Dominica",
                    "Ecuador", "El Salvador", "Estados Unidos", "Granada", "Guatemala",
                    "Guyana", "Hait√≠", "Honduras", "Jamaica", "M√©xico", "Nicaragua",
                    "Panam√°", "Paraguay", "Per√∫", "Rep√∫blica Dominicana", "San Crist√≥bal y Nieves",
                    "San Vicente y las Granadinas", "Santa Luc√≠a", "Surinam", "Trinidad y Tobago",
                    "Uruguay", "Venezuela",
                    
                    // √Åfrica
                    "Angola", "Argelia", "Ben√≠n", "Botsuana", "Burkina Faso", "Burundi",
                    "Cabo Verde", "Camer√∫n", "Chad", "Comoras", "Congo", "Costa de Marfil",
                    "Egipto", "Eritrea", "Esuatini (Suazilandia)", "Etiop√≠a", "Gab√≥n",
                    "Gambia", "Ghana", "Guinea", "Guinea-Bis√°u", "Guinea Ecuatorial",
                    "Kenia", "Lesoto", "Liberia", "Libia", "Madagascar", "Malaui",
                    "Mali", "Marruecos", "Mauricio", "Mauritania", "Mozambique",
                    "Namibia", "N√≠ger", "Nigeria", "Rep√∫blica Centroafricana",
                    "Rep√∫blica Democr√°tica del Congo", "Ruanda", "Santo Tom√© y Pr√≠ncipe",
                    "Senegal", "Seychelles", "Sierra Leona", "Somalia", "Sud√°frica",
                    "Sud√°n", "Sud√°n del Sur", "Tanzania", "Togo", "T√∫nez", "Uganda",
                    "Yibuti", "Zambia", "Zimbabue",
                    
                    // Ocean√≠a
                    "Australia", "Fiyi", "Islas Marshall", "Islas Salom√≥n", "Kiribati",
                    "Micronesia", "Nauru", "Nueva Zelanda", "Palaos", "Pap√∫a Nueva Guinea",
                    "Samoa", "Tonga", "Tuvalu", "Vanuatu"
                ].sort();
                
                this.vacacionesPersonales = new Set();
                this.viajes = [];
                this.viajeEditando = null;
                this.modoVacaciones = false;
                
                // Claves de almacenamiento
                this.STORAGE_VACACIONES = 'vacaciones-torres-2026';
                this.STORAGE_VIAJES = 'viajes-torres-2026';
                
                this.init();
            }
            
            init() {
                this.cargarDatos(); this.cargarHistorico();
                this.renderizarCalendario();
                this.setupEventListeners();
                this.renderizarListaViajes();
                this.cargarPaises();
                this.actualizarEstadisticas();
            }
            
            cargarDatos() {
                // Cargar vacaciones
                try {
                    const saved = localStorage.getItem(this.STORAGE_VACACIONES);
                    if (saved) {
                        this.vacacionesPersonales = new Set(JSON.parse(saved));
                    }
                } catch (e) {
                    this.vacacionesPersonales = new Set();
                }
                
                // Cargar viajes
                try {
                    const saved = localStorage.getItem(this.STORAGE_VIAJES);
                    if (saved) {
                        this.viajes = JSON.parse(saved);
                    }
                } catch (e) {
                    this.viajes = [];
                }
            }
            
            guardarVacaciones() {
                try {
                    localStorage.setItem(
                        this.STORAGE_VACACIONES, 
                        JSON.stringify(Array.from(this.vacacionesPersonales))
                    );
                    this.actualizarEstadisticas();
                } catch (e) {
                    console.error('Error guardando vacaciones:', e);
                }
            }
            
            guardarViajes() {
                try {
                    localStorage.setItem(
                        this.STORAGE_VIAJES, 
                        JSON.stringify(this.viajes)
                    );
                    this.actualizarEstadisticas();
                } catch (e) {
                    console.error('Error guardando viajes:', e);
                }
            }
            
            actualizarEstadisticas() {
                document.getElementById('statViajes').textContent = this.viajes.length;
                document.getElementById('statVacaciones').textContent = this.vacacionesPersonales.size;
            }
            
            cargarPaises() {
                const selectPais = document.getElementById('pais');
                selectPais.innerHTML = '<option value="">Selecciona un pa√≠s</option>';
                
                this.paises.forEach(pais => {
                    const option = document.createElement('option');
                    option.value = pais;
                    option.textContent = pais;
                    selectPais.appendChild(option);
                });
            }
            
            setupEventListeners() {
                // Navegaci√≥n entre vistas
                document.getElementById('btnMisViajes').addEventListener('click', () => {
                    this.mostrarVistaViajes();
                });
                
                document.getElementById('volverCalendario').addEventListener('click', () => {
                    this.mostrarVistaCalendario();
                });
                
                document.getElementById('volverListaViajes').addEventListener('click', () => {
                    this.mostrarListaViajes();
                });
                
                document.getElementById('cancelarViaje').addEventListener('click', () => {
                    this.mostrarListaViajes();
                });
                
                // Formulario de viaje
                document.getElementById('btnNuevoViaje').addEventListener('click', () => {
                    this.mostrarFormularioViaje();
                });
                
                document.getElementById('formViaje').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.guardarViajeFormulario();
                });
                
                // BOT√ìN ELIMINAR EN FORMULARIO - MODAL PERSONALIZADO
                document.getElementById('btnEliminarViaje').addEventListener('click', () => {
                    if (this.viajeEditando) {
                        this.mostrarConfirmacionEliminar();
                    }
                });
                
                // Modal del calendario
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.cerrarModal();
                });
                
                document.getElementById('modalOverlay').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('modalOverlay')) {
                        this.cerrarModal();
                    }
                });
                
                // Bot√≥n toggle vacaciones en modal
                document.getElementById('btnToggleVacaciones').addEventListener('click', () => {
                    this.modoVacaciones = !this.modoVacaciones;
                    const btn = document.getElementById('btnToggleVacaciones');
                    if (this.modoVacaciones) {
                        btn.textContent = '‚úÖ MODO VACACIONES ACTIVO (toca d√≠as)';
                        btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%)';
                    } else {
                        btn.textContent = 'üèñÔ∏è MARCAR/DESMARCAR VACACIONES';
                        btn.style.background = 'linear-gradient(135deg, #e91e63 0%, #c2185b 100%)';
                    }
                    this.actualizarEventosDiasModal();
                });
                
                // Info del d√≠a
                document.getElementById('closeDayInfo').addEventListener('click', () => {
                    this.cerrarInfoDia();
                });
                
                document.getElementById('closeDayInfoBtn').addEventListener('click', () => {
                    this.cerrarInfoDia();
                });
                
                document.getElementById('dayInfoOverlay').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('dayInfoOverlay')) {
                        this.cerrarInfoDia();
                    }
                });
                
                // Backup
                document.getElementById('btnExportar').addEventListener('click', () => {
                    this.exportarDatos();
                });
                
                document.getElementById('btnImportar').addEventListener('click', () => {
                    document.getElementById('fileImport').click();
                });
                
                document.getElementById('btnImportarIOS').addEventListener('click', () => {
                    this.mostrarModalImportacionIOS();
                });
                
                document.getElementById('fileImport').addEventListener('change', (e) => {
                    this.importarDatos(e);
                });
                
                // iOS Shortcuts Import
                document.getElementById('iosCancelBtn').addEventListener('click', () => {
                    this.cerrarModalImportacionIOS();
                });
                
                document.getElementById('iosImportBtn').addEventListener('click', () => {
                    this.procesarImportacionIOS();
                });
                
                document.getElementById('iosImportOverlay').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('iosImportOverlay')) {
                        this.cerrarModalImportacionIOS();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.cerrarModal();
                        this.cerrarInfoDia();
                        this.cerrarConfirmacionEliminar();
                        this.cerrarModalImportacionIOS();
                    }
                });
                
                // Eventos para abrir modal al hacer clic en cualquier parte del mes
                document.getElementById('calendar').addEventListener('click', (e) => {
                    let monthElement = e.target.closest('.month');
                    
                    if (monthElement) {
                        const monthIndex = parseInt(monthElement.dataset.monthIndex);
                        if (!isNaN(monthIndex)) {
                            this.abrirVistaMes(monthIndex);
                        }
                    }
                });
            }
            
            // ==================== IMPORTACI√ìN iOS SHORTCUTS ====================
            
            mostrarModalImportacionIOS() {
                document.getElementById('iosImportTextarea').value = '';
                document.getElementById('iosImportOverlay').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('iosImportTextarea').focus();
                }, 100);
            }
            
            cerrarModalImportacionIOS() {
                document.getElementById('iosImportOverlay').style.display = 'none';
            }
            
            procesarImportacionIOS() {
                const texto = document.getElementById('iosImportTextarea').value.trim();
                
                if (!texto) {
                    alert('‚ùå Por favor, pega el contenido del backup');
                    return;
                }
                
                try {
                    const datos = JSON.parse(texto);
                    
                    // Validaci√≥n b√°sica
                    if (!datos.viajes || !Array.isArray(datos.viajes)) {
                        throw new Error('Formato de backup inv√°lido');
                    }
                    
                    // Mostrar confirmaci√≥n
                    const fechaBackup = datos.fechaExportacion ? 
                        new Date(datos.fechaExportacion).toLocaleDateString('es-ES', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        }) : 'Fecha desconocida';
                    
                    const mensaje = `¬øIMPORTAR ESTE BACKUP?\n\n` +
                                   `üìÖ Viajes: ${datos.viajes.length}\n` +
                                   `üèñÔ∏è D√≠as de vacaciones: ${datos.vacaciones?.length || 0}\n` +
                                   `üìÜ Fecha backup: ${fechaBackup}\n\n` +
                                   `‚ö†Ô∏è Esto REEMPLAZAR√Å todos tus datos actuales.`;
                    
                    if (!confirm(mensaje)) {
                        return;
                    }
                    
                    // ===== LIMPIAR Y REEMPLAZAR DATOS =====
                    
                    // 1. Limpiar datos actuales
                    this.viajes = [];
                    this.vacacionesPersonales.clear();
                    
                    // 2. Importar viajes (con validaci√≥n)
                    if (datos.viajes && Array.isArray(datos.viajes)) {
                        // Filtrar solo viajes v√°lidos
                        this.viajes = datos.viajes.filter(viaje => 
                            viaje && 
                            viaje.id && 
                            viaje.pais && 
                            viaje.fechaInicio && 
                            viaje.fechaFin && 
                            viaje.cliente
                        );
                        
                        // Asegurar que cada viaje tiene el array de d√≠as
                        this.viajes.forEach(viaje => {
                            if (!viaje.dias || !Array.isArray(viaje.dias)) {
                                // Recalcular d√≠as si faltan
                                const diasViaje = [];
                                const inicio = new Date(viaje.fechaInicio);
                                const fin = new Date(viaje.fechaFin);
                                
                                for (let d = new Date(inicio); d <= fin; d.setDate(d.getDate() + 1)) {
                                    diasViaje.push(this.formatearFecha(d));
                                }
                                viaje.dias = diasViaje;
                            }
                        });
                    }
                    
                    // 3. Importar vacaciones
                    if (datos.vacaciones && Array.isArray(datos.vacaciones)) {
                        // Filtrar solo fechas v√°lidas
                        const fechasValidas = datos.vacaciones.filter(fecha => 
                            fecha && 
                            typeof fecha === 'string' && 
                            /^\d{4}-\d{2}-\d{2}$/.test(fecha)
                        );
                        this.vacacionesPersonales = new Set(fechasValidas);
                    }
                    
                    // 4. GUARDAR INMEDIATAMENTE en localStorage
                    this.guardarViajes();
                    this.guardarVacaciones();
                    
                    // 5. REFRESCAR TODAS LAS VISTAS
                    this.renderizarCalendario();
                    this.renderizarListaViajes();
                    this.actualizarEstadisticas();
                    
                    // 6. Cerrar modal
                    this.cerrarModalImportacionIOS();
                    
                    // 7. Mostrar confirmaci√≥n
                    setTimeout(() => {
                        alert(`‚úÖ IMPORTACI√ìN COMPLETADA\n\n` +
                              `‚úàÔ∏è Viajes: ${this.viajes.length}\n` +
                              `üèñÔ∏è D√≠as de vacaciones: ${this.vacacionesPersonales.size}\n\n` +
                              `Los datos se han cargado correctamente.`);
                    }, 100);
                    
                } catch (error) {
                    console.error('Error en importaci√≥n iOS:', error);
                    alert(`‚ùå Error al importar:\n${error.message}\n\nAseg√∫rate de que es un backup v√°lido de esta aplicaci√≥n.`);
                }
            }
            
            // ==================== BACKUP SYSTEM PARA iOS SHORTCUTS ====================
            
            exportarDatos() {
                try {
                    const datos = {
                        vacaciones: Array.from(this.vacacionesPersonales),
                        viajes: this.viajes,
                        fechaExportacion: new Date().toISOString(),
                        totalViajes: this.viajes.length,
                        totalVacaciones: this.vacacionesPersonales.size,
                        version: '1.0',
                        tipo: 'Calendario Torres de Elorz 2026'
                    };
                    
                    const datosStr = JSON.stringify(datos, null, 2);
                    const fecha = new Date().toISOString().split('T')[0];
                    
                    // Mostrar modal con opciones para iOS Shortcuts
                    this.mostrarModalExportacion(datosStr, fecha);
                    
                } catch (error) {
                    alert('‚ùå Error al exportar datos: ' + error.message);
                }
            }
            
            mostrarModalExportacion(datosStr, fecha) {
                const modalHTML = `
                    <div class="confirm-modal-overlay" id="exportModal">
                        <div class="backup-modal-content">
                            <h3 class="confirm-modal-title">üíæ EXPORTAR BACKUP</h3>
                            
                            <div class="backup-modal-stats">
                                <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 24px; color: #2196F3;">${this.viajes.length}</div>
                                        <div style="font-size: 12px; color: #666;">Viajes</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 24px; color: #4CAF50;">${this.vacacionesPersonales.size}</div>
                                        <div style="font-size: 12px; color: #666;">D√≠as vacaciones</div>
                                    </div>
                                </div>
                                <div style="text-align: center; font-size: 12px; color: #888;">
                                    Fecha: ${fecha}
                                </div>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <p style="font-size: 14px; color: #666; margin-bottom: 15px; text-align: center;">
                                    Elige c√≥mo quieres guardar tu backup:
                                </p>
                                
                                <div class="backup-options">
                                    <button class="backup-option-btn btn-copy" id="copyToClipboardBtn">
                                        üìã Copiar al portapapeles
                                    </button>
                                    
                                    <button class="backup-option-btn btn-share" id="shareBtn">
                                        üì§ Compartir/Guardar en Archivos
                                    </button>
                                    
                                    <button class="backup-option-btn btn-view" id="viewBtn">
                                        üëÅÔ∏è Ver contenido
                                    </button>
                                    
                                    <button class="backup-option-btn btn-cancel" id="cancelExportBtn">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer);
                
                // Event listeners
                document.getElementById('copyToClipboardBtn').addEventListener('click', () => {
                    this.copiarAlPortapapeles(datosStr, fecha);
                    document.body.removeChild(modalContainer);
                });
                
                document.getElementById('shareBtn').addEventListener('click', () => {
                    this.compartirArchivo(datosStr, fecha);
                    document.body.removeChild(modalContainer);
                });
                
                document.getElementById('viewBtn').addEventListener('click', () => {
                    this.mostrarContenidoBackup(datosStr, fecha);
                    document.body.removeChild(modalContainer);
                });
                
                document.getElementById('cancelExportBtn').addEventListener('click', () => {
                    document.body.removeChild(modalContainer);
                });
                
                document.getElementById('exportModal').addEventListener('click', (e) => {
                    if (e.target.id === 'exportModal') {
                        document.body.removeChild(modalContainer);
                    }
                });
            }
            
            copiarAlPortapapeles(datosStr, fecha) {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(datosStr).then(() => {
                        alert(`‚úÖ BACKUP COPIADO AL PORTAPAPELES\n\nüìÖ Fecha: ${fecha}\n‚úàÔ∏è Viajes: ${this.viajes.length}\nüèñÔ∏è D√≠as vacaciones: ${this.vacacionesPersonales.size}\n\nAhora puedes:\n1. Pegar en Notas\n2. Pegar en un mensaje\n3. Pegar en la app Archivos`);
                    }).catch(err => {
                        // Fallback para iOS antiguo
                        const textarea = document.createElement('textarea');
                        textarea.value = datosStr;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        alert(`‚úÖ Backup copiado al portapapeles (m√©todo alternativo)`);
                    });
                } else {
                    // M√©todo alternativo
                    const textarea = document.createElement('textarea');
                    textarea.value = datosStr;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert(`‚úÖ Backup copiado al portapapeles`);
                }
            }
            
            compartirArchivo(datosStr, fecha) {
                // Crear blob y archivo
                const blob = new Blob([datosStr], { type: 'application/json' });
                const file = new File([blob], `calendario-torres-backup-${fecha}.json`, { 
                    type: 'application/json',
                    lastModified: Date.now()
                });
                
                // Intentar usar Web Share API (iOS 13+)
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    navigator.share({
                        files: [file],
                        title: 'Backup Calendario Torres',
                        text: `Backup con ${this.viajes.length} viajes y ${this.vacacionesPersonales.size} d√≠as de vacaciones`
                    }).then(() => {
                        console.log('Backup compartido con √©xito');
                    }).catch((error) => {
                        console.log('Error al compartir:', error);
                        // Fallback: mostrar contenido
                        this.mostrarContenidoBackup(datosStr, fecha);
                    });
                } else {
                    // Fallback para iOS Shortcuts
                    const mensaje = `üìÅ GUARDAR BACKUP EN ARCHIVOS\n\n` +
                                  `En iOS Shortcuts, sigue estos pasos:\n\n` +
                                  `1. Toca "Compartir" (icono cuadrado con flecha arriba)\n` +
                                  `2. Despl√°zate y selecciona "Guardar en Archivos"\n` +
                                  `3. Elige una carpeta (recomendado: iCloud Drive)\n` +
                                  `4. Pulsa "Guardar"\n\n` +
                                  `O tambi√©n puedes:\n` +
                                  `‚Ä¢ Enviar por email a ti mismo\n` +
                                  `‚Ä¢ Guardar en Notas\n` +
                                  `‚Ä¢ Pegar en un mensaje\n\n` +
                                  `¬øQuieres copiar el contenido al portapapeles?`;
                    
                    if (confirm(mensaje)) {
                        this.copiarAlPortapapeles(datosStr, fecha);
                    }
                }
            }
            
            mostrarContenidoBackup(datosStr, fecha) {
                const datos = JSON.parse(datosStr);
                const modalHTML = `
                    <div class="confirm-modal-overlay" id="contentModal">
                        <div class="confirm-modal-content" style="max-width: 500px; max-height: 80vh; overflow: hidden;">
                            <h3 class="confirm-modal-title">üìÑ CONTENIDO DEL BACKUP</h3>
                            <div style="margin: 10px 0; font-size: 12px; color: #666; text-align: center;">
                                Fecha: ${fecha} | Viajes: ${datos.totalViajes} | D√≠as vacaciones: ${datos.totalVacaciones}
                            </div>
                            <textarea id="backupContent" 
                                style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ddd; 
                                       border-radius: 6px; font-family: 'Menlo', 'Monaco', monospace; 
                                       font-size: 11px; margin-bottom: 15px; resize: none;"
                                readonly>${datosStr}</textarea>
                            <div style="display: flex; gap: 10px;">
                                <button id="copyContentBtn" style="flex: 1; padding: 10px; background: #4CAF50; 
                                        color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    üìã Copiar todo
                                </button>
                                <button id="closeContentBtn" style="flex: 1; padding: 10px; background: #f5f5f5; 
                                        color: #333; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer);
                
                // Auto-seleccionar texto
                setTimeout(() => {
                    const textarea = document.getElementById('backupContent');
                    textarea.select();
                }, 100);
                
                // Event listeners
                document.getElementById('copyContentBtn').addEventListener('click', () => {
                    const textarea = document.getElementById('backupContent');
                    textarea.select();
                    document.execCommand('copy');
                    alert('‚úÖ Contenido copiado al portapapeles');
                });
                
                document.getElementById('closeContentBtn').addEventListener('click', () => {
                    document.body.removeChild(modalContainer);
                });
                
                document.getElementById('contentModal').addEventListener('click', (e) => {
                    if (e.target.id === 'contentModal') {
                        document.body.removeChild(modalContainer);
                    }
                });
            }
            
            // ==================== IMPORTACI√ìN CORREGIDA ====================
            
            importarDatos(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Limpiar input
                event.target.value = '';
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const datos = JSON.parse(e.target.result);
                        
                        // Validaci√≥n b√°sica
                        if (!datos.viajes || !Array.isArray(datos.viajes)) {
                            throw new Error('Formato de archivo inv√°lido');
                        }
                        
                        // Mostrar confirmaci√≥n
                        const fechaBackup = datos.fechaExportacion ? 
                            new Date(datos.fechaExportacion).toLocaleDateString('es-ES', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            }) : 'Fecha desconocida';
                        
                        const mensaje = `¬øIMPORTAR ESTE BACKUP?\n\n` +
                                       `üìÖ Viajes: ${datos.viajes.length}\n` +
                                       `üèñÔ∏è D√≠as de vacaciones: ${datos.vacaciones?.length || 0}\n` +
                                       `üìÜ Fecha backup: ${fechaBackup}\n\n` +
                                       `‚ö†Ô∏è Esto REEMPLAZAR√Å todos tus datos actuales.`;
                        
                        if (!confirm(mensaje)) {
                            return;
                        }
                        
                        // ===== LIMPIAR Y REEMPLAZAR DATOS =====
                        
                        // 1. Limpiar datos actuales
                        this.viajes = [];
                        this.vacacionesPersonales.clear();
                        
                        // 2. Importar viajes (con validaci√≥n)
                        if (datos.viajes && Array.isArray(datos.viajes)) {
                            // Filtrar solo viajes v√°lidos
                            this.viajes = datos.viajes.filter(viaje => 
                                viaje && 
                                viaje.id && 
                                viaje.pais && 
                                viaje.fechaInicio && 
                                viaje.fechaFin && 
                                viaje.cliente
                            );
                            
                            // Asegurar que cada viaje tiene el array de d√≠as
                            this.viajes.forEach(viaje => {
                                if (!viaje.dias || !Array.isArray(viaje.dias)) {
                                    // Recalcular d√≠as si faltan
                                    const diasViaje = [];
                                    const inicio = new Date(viaje.fechaInicio);
                                    const fin = new Date(viaje.fechaFin);
                                    
                                    for (let d = new Date(inicio); d <= fin; d.setDate(d.getDate() + 1)) {
                                        diasViaje.push(this.formatearFecha(d));
                                    }
                                    viaje.dias = diasViaje;
                                }
                            });
                        }
                        
                        // 3. Importar vacaciones
                        if (datos.vacaciones && Array.isArray(datos.vacaciones)) {
                            // Filtrar solo fechas v√°lidas
                            const fechasValidas = datos.vacaciones.filter(fecha => 
                                fecha && 
                                typeof fecha === 'string' && 
                                /^\d{4}-\d{2}-\d{2}$/.test(fecha)
                            );
                            this.vacacionesPersonales = new Set(fechasValidas);
                        }
                        
                        // 4. GUARDAR INMEDIATAMENTE en localStorage
                        this.guardarViajes();
                        this.guardarVacaciones();
                        
                        // 5. REFRESCAR TODAS LAS VISTAS
                        this.renderizarCalendario();
                        this.renderizarListaViajes();
                        this.actualizarEstadisticas();
                        
                        // 6. Forzar recarga de la vista actual
                        if (document.getElementById('vistaViajes').style.display === 'block') {
                            // Si estamos en la vista de viajes, refrescar
                            this.mostrarVistaCalendario();
                            setTimeout(() => {
                                this.mostrarVistaViajes();
                            }, 50);
                        } else {
                            // Si estamos en vista calendario, forzar re-render
                            this.mostrarVistaCalendario();
                        }
                        
                        // 7. Mostrar confirmaci√≥n
                        setTimeout(() => {
                            alert(`‚úÖ IMPORTACI√ìN COMPLETADA\n\n` +
                                  `‚úàÔ∏è Viajes: ${this.viajes.length}\n` +
                                  `üèñÔ∏è D√≠as de vacaciones: ${this.vacacionesPersonales.size}\n\n` +
                                  `Los datos se han cargado correctamente.`);
                        }, 100);
                        
                    } catch (error) {
                        console.error('Error en importaci√≥n:', error);
                        alert(`‚ùå Error al importar:\n${error.message}\n\nAseg√∫rate de que es un backup v√°lido de esta aplicaci√≥n.`);
                    }
                };
                
                reader.onerror = () => {
                    alert('‚ùå Error al leer el archivo.');
                };
                
                reader.readAsText(file);
            }
            
            // ==================== MODAL DE CONFIRMACI√ìN ====================
            
            mostrarConfirmacionEliminar() {
                // Crear el modal
                const modalHTML = `
                    <div class="confirm-modal-overlay" id="confirmModalOverlay">
                        <div class="confirm-modal-content">
                            <h3 class="confirm-modal-title">üóëÔ∏è Eliminar viaje</h3>
                            <p class="confirm-modal-message">
                                ¬øEst√°s seguro de que quieres eliminar este viaje?<br>
                                Esta acci√≥n no se puede deshacer.
                            </p>
                            <div class="confirm-modal-buttons">
                                <button class="confirm-btn-cancel" id="confirmCancel">Cancelar</button>
                                <button class="confirm-btn-delete" id="confirmDelete">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // A√±adir al body
                const modalContainer = document.createElement('div');
                modalContainer.innerHTML = modalHTML;
                document.body.appendChild(modalContainer);
                
                // Event listeners
                document.getElementById('confirmCancel').addEventListener('click', () => {
                    this.cerrarConfirmacionEliminar();
                });
                
                document.getElementById('confirmDelete').addEventListener('click', () => {
                    if (this.viajeEditando) {
                        this.eliminarViaje(this.viajeEditando.id);
                    }
                    this.cerrarConfirmacionEliminar();
                });
                
                // Cerrar al hacer clic fuera
                document.getElementById('confirmModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'confirmModalOverlay') {
                        this.cerrarConfirmacionEliminar();
                    }
                });
            }
            
            cerrarConfirmacionEliminar() {
                const modal = document.querySelector('.confirm-modal-overlay')?.parentElement;
                if (modal) {
                    document.body.removeChild(modal);
                }
            }
            
            // ==================== NAVEGACI√ìN ENTRE VISTAS ====================
            
            mostrarVistaCalendario() {
                document.getElementById('vistaCalendario').style.display = 'block';
                document.getElementById('vistaViajes').style.display = 'none';
                document.getElementById('formularioViaje').style.display = 'none';
                this.renderizarCalendario();
                this.actualizarEstadisticas();
            }
            
            mostrarVistaViajes() {
                document.getElementById('vistaCalendario').style.display = 'none';
                document.getElementById('vistaViajes').style.display = 'block';
                document.getElementById('formularioViaje').style.display = 'none';
                this.renderizarListaViajes();
            }
            
            mostrarListaViajes() {
                document.getElementById('vistaViajes').style.display = 'block';
                document.getElementById('formularioViaje').style.display = 'none';
                this.renderizarListaViajes();
            }
            
            mostrarFormularioViaje(viaje = null) {
                this.viajeEditando = viaje;
                document.getElementById('vistaViajes').style.display = 'none';
                document.getElementById('formularioViaje').style.display = 'block';
                
                const titulo = document.getElementById('tituloFormulario');
                const form = document.getElementById('formViaje');
                const btnEliminar = document.getElementById('btnEliminarViaje');
                
                if (viaje) {
                    titulo.textContent = 'EDITAR VIAJE';
                    document.getElementById('viajeId').value = viaje.id;
                    document.getElementById('pais').value = viaje.pais;
                    document.getElementById('ciudadDestino').value = viaje.ciudadDestino || '';
                    document.getElementById('fechaInicio').value = viaje.fechaInicio;
                    document.getElementById('fechaFin').value = viaje.fechaFin;
                    document.getElementById('cliente').value = viaje.cliente;
                    btnEliminar.style.display = 'block';
                } else {
                    titulo.textContent = 'NUEVO VIAJE';
                    form.reset();
                    document.getElementById('viajeId').value = '';
                    document.getElementById('fechaInicio').value = '';
                    document.getElementById('fechaFin').value = '';
                    btnEliminar.style.display = 'none';
                }
            }
            
            // ==================== GESTI√ìN DE VIAJES ====================
            
            generarIdViaje() {
                return 'viaje_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            guardarViajeFormulario() {
                const id = document.getElementById('viajeId').value;
                const pais = document.getElementById('pais').value;
                const ciudadDestino = document.getElementById('ciudadDestino').value;
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                const cliente = document.getElementById('cliente').value;
                
                if (!pais || !fechaInicio || !fechaFin || !cliente) {
                    alert('Por favor, completa todos los campos obligatorios');
                    return;
                }
                
                if (new Date(fechaFin) < new Date(fechaInicio)) {
                    alert('La fecha de fin no puede ser anterior a la fecha de inicio');
                    return;
                }
                
                // Generar array de d√≠as del viaje
                const diasViaje = [];
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                
                for (let d = new Date(inicio); d <= fin; d.setDate(d.getDate() + 1)) {
                    diasViaje.push(this.formatearFecha(d));
                }
                
                const viaje = {
                    id: id || this.generarIdViaje(),
                    pais,
                    ciudadDestino,
                    fechaInicio,
                    fechaFin,
                    cliente,
                    dias: diasViaje,
                    fechaCreacion: new Date().toISOString()
                };
                
                if (this.viajeEditando) {
                    const index = this.viajes.findIndex(v => v.id === this.viajeEditando.id);
                    if (index !== -1) {
                        this.viajes[index] = viaje;
                    }
                } else {
                    this.viajes.push(viaje);
                }
                
                this.guardarViajes();
                this.renderizarCalendario();
                this.mostrarVistaCalendario();
            }
            
            editarViaje(id) {
                const viaje = this.viajes.find(v => v.id === id);
                if (viaje) {
                    this.mostrarFormularioViaje(viaje);
                }
            }
            
            eliminarViaje(id) {
                this.viajes = this.viajes.filter(v => v.id !== id);
                this.guardarViajes();
                this.renderizarCalendario();
                this.mostrarVistaCalendario();
                this.cerrarConfirmacionEliminar();
            }
            
            renderizarListaViajes() {
                const lista = document.getElementById('listaViajes');
                lista.innerHTML = '';
                
                if (this.viajes.length === 0) {
                    lista.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay viajes registrados</p>';
                    return;
                }
                
                // Agrupar viajes por mes
                const viajesPorMes = {};
                
                this.viajes.forEach(viaje => {
                    const mes = new Date(viaje.fechaInicio).getMonth();
                    if (!viajesPorMes[mes]) {
                        viajesPorMes[mes] = [];
                    }
                    viajesPorMes[mes].push(viaje);
                });
                
                // Ordenar meses
                const mesesOrdenados = Object.keys(viajesPorMes).sort((a, b) => a - b);
                
                mesesOrdenados.forEach(mesIndex => {
                    const mesNombre = this.meses[parseInt(mesIndex)];
                    const viajesMes = viajesPorMes[mesIndex];
                    
                    viajesMes.sort((a, b) => new Date(a.fechaInicio) - new Date(b.fechaInicio));
                    
                    const mesSection = document.createElement('div');
                    mesSection.innerHTML = `<h3 style="margin: 15px 0 10px 0; color: #333;">üóìÔ∏è ${mesNombre} 2026</h3>`;
                    lista.appendChild(mesSection);
                    
                    viajesMes.forEach(viaje => {
                        const card = this.crearCardViaje(viaje);
                        lista.appendChild(card);
                    });
                });
            }
            
            crearCardViaje(viaje) {
                const card = document.createElement('div');
                card.className = 'viaje-card';
                
                const inicio = new Date(viaje.fechaInicio);
                const fin = new Date(viaje.fechaFin);
                const dias = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
                
                const destino = viaje.ciudadDestino 
                    ? `${viaje.ciudadDestino} (${viaje.pais})`
                    : viaje.pais;
                
                card.innerHTML = `
                    <div class="viaje-card-header">
                        <div class="viaje-destino-card">üó∫Ô∏è ${destino}</div>
                        <div class="viaje-acciones">
                            <button class="btn-editar" data-id="${viaje.id}">‚úèÔ∏è Editar</button>
                        </div>
                    </div>
                    <div class="viaje-cliente-card">üë§ ${viaje.cliente}</div>
                    <div class="viaje-fechas">
                        üìÖ ${this.formatearFechaVisual(inicio)} - ${this.formatearFechaVisual(fin)} (${dias} d√≠a${dias !== 1 ? 's' : ''})
                    </div>
                `;
                
                // Event listener para editar
                const btnEditar = card.querySelector('.btn-editar');
                btnEditar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.editarViaje(viaje.id);
                });
                
                return card;
            }
            
            // ==================== FUNCIONES DEL CALENDARIO ====================
            
            getWeekNumber(date) {
                const target = new Date(date.valueOf());
                const dayNr = (date.getDay() + 6) % 7;
                target.setDate(target.getDate() - dayNr + 3);
                
                const firstThursday = target.valueOf();
                target.setMonth(0, 1);
                
                if (target.getDay() !== 4) {
                    target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
                }
                
                return 1 + Math.ceil((firstThursday - target) / (86400000 * 7));
            }
            
            formatearFecha(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            formatearFechaVisual(date) {
                const day = date.getDate();
                const month = date.getMonth() + 1;
                return `${day}/${month}`;
            }
            
            formatearFechaCompleta(date) {
                const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                const diaSemana = dias[date.getDay()];
                const dia = date.getDate();
                const mes = meses[date.getMonth()];
                const a√±o = date.getFullYear();
                
                return `${diaSemana}, ${dia} de ${mes} de ${a√±o}`;
            }
            
            getDayClass(dateStr, dayOfWeek) {
                if (dayOfWeek === 0 || dayOfWeek === 6) return 'weekend';
                if (this.diasEspeciales.festivos.has(dateStr)) return 'festivo';
                if (this.diasEspeciales.puentes.has(dateStr)) return 'puente';
                if (this.diasEspeciales.previos.has(dateStr)) return 'previo';
                if (this.diasEspeciales.vacacionales.has(dateStr)) return 'vacacional';
                return '';
            }
            
            getDayType(dateStr) {
                if (this.diasEspeciales.festivos.has(dateStr)) return 'Festivo';
                if (this.diasEspeciales.puentes.has(dateStr)) return 'Puente/Ajuste';
                if (this.diasEspeciales.previos.has(dateStr)) return 'Previo 6h';
                if (this.diasEspeciales.vacacionales.has(dateStr)) return 'Vacacional (empresa)';
                return 'D√≠a laboral';
            }
            
            tieneViaje(dateStr) {
                for (const viaje of this.viajes) {
                    if (viaje.dias && viaje.dias.includes(dateStr)) {
                        return true;
                    }
                }
                return false;
            }
            
            obtenerInfoViajeParaFecha(dateStr) {
                for (const viaje of this.viajes) {
                    if (viaje.dias && viaje.dias.includes(dateStr)) {
                        return viaje;
                    }
                }
                return null;
            }
            
            toggleVacacion(dateStr) {
                if (this.vacacionesPersonales.has(dateStr)) {
                    this.vacacionesPersonales.delete(dateStr);
                } else {
                    this.vacacionesPersonales.add(dateStr);
                }
                this.guardarVacaciones();
                this.renderizarCalendario();
            }
            
            mostrarInfoDia(dateStr) {
                const fecha = new Date(dateStr);
                const title = document.getElementById('dayInfoTitle');
                const body = document.getElementById('dayInfoBody');
                
                title.textContent = this.formatearFechaCompleta(fecha);
                body.innerHTML = '';
                
                // Informaci√≥n del tipo de d√≠a
                const tipoDia = this.getDayType(dateStr);
                const dayOfWeek = fecha.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                let tipoIcono = 'üìÖ';
                let tipoClase = '';
                
                if (this.diasEspeciales.festivos.has(dateStr)) {
                    tipoIcono = 'üéâ';
                    tipoClase = 'info-festivo';
                } else if (this.diasEspeciales.puentes.has(dateStr)) {
                    tipoIcono = 'üåâ';
                    tipoClase = 'info-puente';
                } else if (this.diasEspeciales.previos.has(dateStr)) {
                    tipoIcono = '‚è∞';
                    tipoClase = 'info-previo';
                } else if (this.diasEspeciales.vacacionales.has(dateStr)) {
                    tipoIcono = 'üè¢';
                    tipoClase = 'info-vacacional';
                } else if (isWeekend) {
                    tipoIcono = 'üå¥';
                    tipoClase = '';
                }
                
                const tipoItem = document.createElement('div');
                tipoItem.className = `info-item ${tipoClase}`;
                tipoItem.innerHTML = `
                    <div class="info-icon">${tipoIcono}</div>
                    <div class="info-text"><strong>Tipo:</strong> ${tipoDia}</div>
                `;
                body.appendChild(tipoItem);
                
                // Informaci√≥n de vacaciones personales
                if (this.vacacionesPersonales.has(dateStr)) {
                    const vacacionesItem = document.createElement('div');
                    vacacionesItem.className = 'info-item info-personal';
                    vacacionesItem.innerHTML = `
                        <div class="info-icon">üèñÔ∏è</div>
                        <div class="info-text"><strong>Vacaciones personales:</strong> S√ç</div>
                    `;
                    body.appendChild(vacacionesItem);
                }
                
                // Informaci√≥n de viaje
                const viaje = this.obtenerInfoViajeParaFecha(dateStr);
                if (viaje) {
                    const destino = viaje.ciudadDestino 
                        ? `${viaje.ciudadDestino} (${viaje.pais})`
                        : viaje.pais;
                    
                    const inicio = new Date(viaje.fechaInicio);
                    const fin = new Date(viaje.fechaFin);
                    const dias = Math.floor((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
                    
                    const viajeItem = document.createElement('div');
                    viajeItem.className = 'info-item info-viaje';
                    viajeItem.innerHTML = `
                        <div class="info-icon">‚úàÔ∏è</div>
                        <div class="info-text">
                            <strong>Viaje:</strong> ${destino}<br>
                            <strong>Cliente:</strong> ${viaje.cliente}<br>
                            <strong>Fechas:</strong> ${this.formatearFechaVisual(inicio)} - ${this.formatearFechaVisual(fin)}<br>
                            <strong>Duraci√≥n:</strong> ${dias} d√≠a${dias !== 1 ? 's' : ''}
                        </div>
                    `;
                    body.appendChild(viajeItem);
                }
                
                document.getElementById('dayInfoOverlay').style.display = 'flex';
            }
            
            cerrarInfoDia() {
                document.getElementById('dayInfoOverlay').style.display = 'none';
            }
            
            renderizarCalendario() {
                const container = document.getElementById('calendar');
                container.innerHTML = '';
                
                for (let i = 0; i < this.meses.length; i += 3) {
                    const row = document.createElement('div');
                    row.className = 'months-row';
                    
                    for (let j = 0; j < 3 && (i + j) < this.meses.length; j++) {
                        const monthIndex = i + j;
                        const monthElement = this.crearElementoMes(this.meses[monthIndex], monthIndex);
                        monthElement.dataset.monthIndex = monthIndex;
                        row.appendChild(monthElement);
                    }
                    
                    container.appendChild(row);
                }
            }
            
            crearElementoMes(nombreMes, mesIndex) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month';
                
                const header = document.createElement('div');
                header.className = 'month-header';
                header.textContent = nombreMes;
                monthDiv.appendChild(header);
                
                const grid = document.createElement('div');
                grid.className = 'calendar-grid';
                
                this.crearHeadersGrid(grid);
                this.crearDiasMes(grid, mesIndex, false);
                
                monthDiv.appendChild(grid);
                return monthDiv;
            }
            
            crearHeadersGrid(grid) {
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                weekHeader.textContent = 'S';
                grid.appendChild(weekHeader);
                
                this.diasSemana.forEach(dia => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = dia;
                    grid.appendChild(dayHeader);
                });
            }
            
            crearDiasMes(grid, mesIndex, isModal = false) {
                const firstDay = new Date(2026, mesIndex, 1);
                const lastDay = new Date(2026, mesIndex + 1, 0);
                
                let startingDayOfWeek = firstDay.getDay();
                startingDayOfWeek = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
                
                let currentWeek = this.getWeekNumber(firstDay);
                let addedWeekNumber = false;
                
                if (startingDayOfWeek > 0) {
                    this.agregarCeldaNumeroSemana(grid, currentWeek, isModal);
                    addedWeekNumber = true;
                    
                    for (let i = 0; i < startingDayOfWeek; i++) {
                        grid.appendChild(this.crearDiaVacio(isModal));
                    }
                }
                
                let currentDayOfWeek = startingDayOfWeek;
                
                for (let dia = 1; dia <= lastDay.getDate(); dia++) {
                    if (currentDayOfWeek === 0 && dia > 1) {
                        currentWeek = this.getWeekNumber(new Date(2026, mesIndex, dia));
                        this.agregarCeldaNumeroSemana(grid, currentWeek, isModal);
                        addedWeekNumber = true;
                    } else if (dia === 1 && !addedWeekNumber) {
                        this.agregarCeldaNumeroSemana(grid, currentWeek, isModal);
                        addedWeekNumber = true;
                    }
                    
                    const fecha = new Date(2026, mesIndex, dia);
                    const dateStr = this.formatearFecha(fecha);
                    const dayOfWeek = fecha.getDay();
                    
                    const dayDiv = this.crearElementoDia(dia, dateStr, dayOfWeek, isModal);
                    grid.appendChild(dayDiv);
                    
                    currentDayOfWeek = (currentDayOfWeek + 1) % 7;
                    
                    if (currentDayOfWeek === 0 || dia === lastDay.getDate()) {
                        addedWeekNumber = false;
                    }
                }
            }
            
            agregarCeldaNumeroSemana(grid, weekNumber, isModal = false) {
                const weekNum = document.createElement('div');
                weekNum.className = isModal ? 'modal-week-number' : 'week-number';
                weekNum.textContent = weekNumber;
                grid.appendChild(weekNum);
            }
            
            crearDiaVacio(isModal = false) {
                const emptyDay = document.createElement('div');
                emptyDay.className = isModal ? 'modal-day empty' : 'day empty';
                return emptyDay;
            }
            
            crearElementoDia(numeroDia, dateStr, dayOfWeek, isModal = false) {
                const dayDiv = document.createElement('div');
                const dayClass = this.getDayClass(dateStr, dayOfWeek);
                
                if (isModal) {
                    dayDiv.className = `modal-day ${dayClass}`;
                } else {
                    dayDiv.className = `day ${dayClass}`;
                }
                
                dayDiv.textContent = numeroDia;
                dayDiv.dataset.date = dateStr;
                
                // A√±adir clase de viaje si corresponde
                if (this.tieneViaje(dateStr)) {
                    dayDiv.classList.add('tiene-viaje');
                }
                
                // A√±adir clase de vacaciones personales
                if (this.vacacionesPersonales.has(dateStr)) {
                    dayDiv.classList.add('personal');
                }
                
                return dayDiv;
            }
            
            abrirVistaMes(monthIndex) {
                const modal = document.getElementById('modalOverlay');
                const title = document.getElementById('modalTitle');
                const calendar = document.getElementById('modalCalendar');
                
                title.textContent = `${this.meses[monthIndex]} 2026`;
                calendar.innerHTML = this.crearVistaModal(monthIndex);
                
                this.modoVacaciones = false;
                const btn = document.getElementById('btnToggleVacaciones');
                btn.textContent = 'üèñÔ∏è MARCAR/DESMARCAR VACACIONES';
                btn.style.background = 'linear-gradient(135deg, #e91e63 0%, #c2185b 100%)';
                
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                this.actualizarEventosDiasModal();
            }
            
            cerrarModal() {
                const modal = document.getElementById('modalOverlay');
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                this.renderizarCalendario();
            }
            
            crearVistaModal(monthIndex) {
                const firstDay = new Date(2026, monthIndex, 1);
                const lastDay = new Date(2026, monthIndex + 1, 0);
                
                let html = '<div class="modal-grid">';
                
                html += '<div class="modal-week-header">S</div>';
                
                this.diasSemana.forEach(dia => {
                    html += `<div class="modal-day-header">${dia}</div>`;
                });
                
                let startingDayOfWeek = firstDay.getDay();
                startingDayOfWeek = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
                
                let currentWeek = this.getWeekNumber(firstDay);
                let addedWeekNumber = false;
                
                if (startingDayOfWeek > 0) {
                    html += `<div class="modal-week-number">${currentWeek}</div>`;
                    addedWeekNumber = true;
                    
                    for (let i = 0; i < startingDayOfWeek; i++) {
                        html += '<div class="modal-day empty"></div>';
                    }
                }
                
                let currentDayOfWeek = startingDayOfWeek;
                
                for (let dia = 1; dia <= lastDay.getDate(); dia++) {
                    if (currentDayOfWeek === 0 && dia > 1) {
                        currentWeek = this.getWeekNumber(new Date(2026, monthIndex, dia));
                        html += `<div class="modal-week-number">${currentWeek}</div>`;
                        addedWeekNumber = true;
                    } else if (dia === 1 && !addedWeekNumber) {
                        html += `<div class="modal-week-number">${currentWeek}</div>`;
                        addedWeekNumber = true;
                    }
                    
                    const fecha = new Date(2026, monthIndex, dia);
                    const dateStr = this.formatearFecha(fecha);
                    const dayOfWeek = fecha.getDay();
                    const dayClass = this.getDayClass(dateStr, dayOfWeek);
                    
                    let className = 'modal-day';
                    if (dayClass) className += ` ${dayClass}`;
                    
                    if (this.tieneViaje(dateStr)) className += ' tiene-viaje';
                    if (this.vacacionesPersonales.has(dateStr)) className += ' personal';
                    
                    html += `<div class="${className}" data-date="${dateStr}">${dia}</div>`;
                    
                    currentDayOfWeek = (currentDayOfWeek + 1) % 7;
                    
                    if (currentDayOfWeek === 0 || dia === lastDay.getDate()) {
                        addedWeekNumber = false;
                    }
                }
                
                html += '</div>';
                return html;
            }
            
            actualizarEventosDiasModal() {
                const dias = document.querySelectorAll('.modal-day:not(.empty)');
                
                dias.forEach(day => {
                    const dateStr = day.dataset.date;
                    
                    day.onclick = null;
                    
                    if (this.modoVacaciones) {
                        day.onclick = (e) => {
                            e.stopPropagation();
                            this.toggleVacacion(dateStr);
                            day.classList.toggle('personal');
                        };
                    } else {
                        day.onclick = (e) => {
                            e.stopPropagation();
                            this.mostrarInfoDia(dateStr);
                        };
                    }
                });
            }
        }

        // Inicializar calendario cuando el DOM est√© listo
        
// === HIST√ìRICO: carga/guardado + UI helpers ===
calendario.cargarHistorico = function(){
  try{
    const s = localStorage.getItem(this.STORAGE_HISTORICO);
    if(s) this.historico = JSON.parse(s);
    else this.historico = [];
  }catch{ this.historico = []; }
};
calendario.guardarHistorico = function(){
  try{ localStorage.setItem(this.STORAGE_HISTORICO, JSON.stringify(this.historico)); }
  catch(e){ console.error('Error guardando hist√≥rico', e); }
};

// Rellena select de pa√≠ses en el modal hist√≥rico
calendario._rellenarSelectHistorico = function(){
  const sel = document.getElementById('historicoPais');
  sel.innerHTML = '<option value="">Selecciona un pa√≠s</option>';
  this.paises.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o); });
};

// Pintar listado hist√≥rico
calendario._pintarHistoricoLista = function(){
  const cont = document.getElementById('historicoLista');
  if(!this.historico || this.historico.length===0){ cont.innerHTML='<p style="color:#666;">No hay registros</p>'; return; }
  cont.innerHTML='';
  this.historico.sort((a,b)=>a.pais.localeCompare(b.pais));
  this.historico.forEach((h,idx)=>{
    const d=document.createElement('div');
    d.className='viaje-card';
    d.style.marginBottom='8px';
    d.innerHTML=`<div class="viaje-card-header"><div class="viaje-destino-card">${h.pais}</div>
      <div class="viaje-acciones">
        <button class="btn-editar" data-idx="${idx}">‚úèÔ∏è Editar</button>
        <button class="btn-editar" data-del="${idx}" style="color:#e91e63">üóëÔ∏è Eliminar</button>
      </div></div>
      <div class="viaje-fechas">üìÜ D√≠as previos: ${h.dias||0}</div>`;
    d.querySelector('[data-idx]')?.addEventListener('click', (e)=>{
      const i=parseInt(e.currentTarget.getAttribute('data-idx')); const h=this.historico[i];
      document.getElementById('historicoPais').value=h.pais; document.getElementById('historicoDias').value=h.dias||0;
    });
    d.querySelector('[data-del]')?.addEventListener('click', (e)=>{
      const i=parseInt(e.currentTarget.getAttribute('data-del'));
      if(confirm('¬øEliminar este registro hist√≥rico?')){ this.historico.splice(i,1); this.guardarHistorico(); this._pintarHistoricoLista(); this.pintarMapa?.(); }
    });
    cont.appendChild(d);
  });
};

// === MAPA: diccionario ISO m√≠nimo (extensible) ===
calendario.ISO_BY_PAIS = {
  'Espa√±a':'ES','Francia':'FR','Alemania':'DE','Italia':'IT','Portugal':'PT','Reino Unido':'GB','Irlanda':'IE','Pa√≠ses Bajos':'NL','B√©lgica':'BE','Suiza':'CH','Austria':'AT','Polonia':'PL','Rep√∫blica Checa':'CZ','Dinamarca':'DK','Suecia':'SE','Noruega':'NO','Finlandia':'FI','Estonia':'EE','Letonia':'LV','Lituania':'LT','Hungr√≠a':'HU','Ruman√≠a':'RO','Bulgaria':'BG','Grecia':'GR','Croacia':'HR','Eslovenia':'SI','Eslovaquia':'SK','Chipre':'CY','Malta':'MT','Luxemburgo':'LU',
  'Estados Unidos':'US','Canad√°':'CA','M√©xico':'MX','Brasil':'BR','Argentina':'AR','Chile':'CL','Per√∫':'PE','Colombia':'CO','Uruguay':'UY','Paraguay':'PY','Bolivia':'BO','Ecuador':'EC','Venezuela':'VE','Panam√°':'PA','Costa Rica':'CR','Guatemala':'GT','Honduras':'HN','Nicaragua':'NI','El Salvador':'SV','Cuba':'CU','Rep√∫blica Dominicana':'DO','Puerto Rico':'PR',
  'Marruecos':'MA','Argelia':'DZ','T√∫nez':'TN','Egipto':'EG','Sud√°frica':'ZA','Nigeria':'NG','Senegal':'SN','Ghana':'GH','Etiop√≠a':'ET','Kenia':'KE','Tanzania':'TZ',
  'Turqu√≠a':'TR','Rusia':'RU','Ucrania':'UA','Bielorrusia':'BY','Serbia':'RS','Bosnia y Herzegovina':'BA','Macedonia del Norte':'MK','Montenegro':'ME','Albania':'AL',
  'China':'CN','Jap√≥n':'JP','Corea del Sur':'KR','India':'IN','Indonesia':'ID','Tailandia':'TH','Vietnam':'VN','Malasia':'MY','Singapur':'SG','Filipinas':'PH','Taiw√°n':'TW','Kazajist√°n':'KZ','Emiratos √Årabes Unidos':'AE','Qatar':'QA','Arabia Saudita':'SA','Israel':'IL','Jordania':'JO','L√≠bano':'LB',
  'Australia':'AU','Nueva Zelanda':'NZ'
};

// Carga SVG (tile-map) y eventos
calendario.cargarMapa = async function(){
  const wrap = document.getElementById('mapaSvgWrapper');
  if(wrap.dataset.loaded==='1') return;
  try{
    const resp = await fetch('./world/world.svg');
    const txt = await resp.text();
    wrap.innerHTML = txt;
    wrap.dataset.loaded='1';
    wrap.querySelectorAll('.tile').forEach(el=>{
      el.addEventListener('click', ()=> this.mostrarPopupPais(el.id));
    });
  }catch(e){
    wrap.innerHTML = '<p style="color:#c00;text-align:center;">No se pudo cargar el mapa</p>';
  }
};

// Computa d√≠as 2026 por pa√≠s ISO
calendario._dias2026PorISO = function(){
  const out={};
  for(const v of this.viajes){
    const iso = this.ISO_BY_PAIS[v.pais]; if(!iso) continue;
    if(!out[iso]) out[iso] = new Set();
    (v.dias||[]).forEach(d=> out[iso].add(d));
  }
  return out; // iso -> Set fechas unicas
};

// D√≠as hist√≥ricos por ISO
calendario._diasHistoricoPorISO = function(){
  const out={};
  for(const h of (this.historico||[])){
    const iso = this.ISO_BY_PAIS[h.pais]; if(!iso) continue;
    out[iso] = (out[iso]||0) + (parseInt(h.dias)||0);
  }
  return out; // iso -> numero
};

// Pintado del mapa (fusionando hist√≥rico + 2026)
calendario.pintarMapa = function(){
  const wrap = document.getElementById('mapaSvgWrapper'); if(!wrap || !wrap.dataset.loaded) return;
  const d2026 = this._dias2026PorISO();
  const hist  = this._diasHistoricoPorISO();
  wrap.querySelectorAll('.tile').forEach(el=>{
    const iso = el.id; const total = (d2026[iso]?.size||0) + (hist[iso]||0);
    el.setAttribute('class','tile');
    if(total>=1 && total<=3) el.classList.add('visitado-1-3');
    else if(total>=4 && total<=9) el.classList.add('visitado-4-9');
    else if(total>=10) el.classList.add('visitado-10p');
  });
};

// Popup pa√≠s
calendario.mostrarPopupPais = function(iso){
  const nombre = Object.entries(this.ISO_BY_PAIS).find(([k,v])=>v===iso)?.[0] || iso;
  const d2026 = this._dias2026PorISO();
  const hist  = this._diasHistoricoPorISO();
  const total = (d2026[iso]?.size||0) + (hist[iso]||0);
  // Resumen de viajes 2026
  const viajesPais = this.viajes.filter(v=> this.ISO_BY_PAIS[v.pais]===iso);
  const resumen = viajesPais.map(v=>{
    const i=new Date(v.fechaInicio), f=new Date(v.fechaFin);
    const dias = Math.floor((f-i)/(1000*60*60*24))+1;
    const destino=v.ciudadDestino?`${v.ciudadDestino} (${v.pais})`:v.pais;
    return `‚Ä¢ ${destino} ‚Äî ${this.formatearFechaVisual(i)} - ${this.formatearFechaVisual(f)} (${dias}d)`;
  }).join('<br>');
  document.getElementById('mapTooltipTitle').textContent = nombre;
  document.getElementById('mapTooltipBody').innerHTML =
    `<div class="info-item" style="background:#f0f7ff;border-left:4px solid #2196F3;">
      <div class="info-icon">üìÜ</div>
      <div class="info-text"><strong>Total d√≠as:</strong> ${total} (hist√≥rico ${hist[iso]||0} + 2026 ${d2026[iso]?.size||0})</div>
    </div>` +
    (resumen ? `<div class="info-item"><div class="info-icon">‚úàÔ∏è</div><div class="info-text">${resumen}</div></div>` : '');
  document.getElementById('mapTooltip').style.display='flex';
};

// Navegaci√≥n a vista mapa
calendario.mostrarVistaMapa = function(){
  document.getElementById('vistaCalendario').style.display='none';
  document.getElementById('vistaViajes').style.display='none';
  document.getElementById('formularioViaje').style.display='none';
  document.getElementById('vistaMapa').style.display='block';
  this.cargarMapa().then(()=> this.pintarMapa());
};

// Event wiring extra (se ejecuta tras DOMContentLoaded)
(function(){
  document.getElementById('btnMapaMundial')?.addEventListener('click', ()=>calendario.mostrarVistaMapa());
  document.getElementById('volverDesdeMapa')?.addEventListener('click', ()=>calendario.mostrarVistaCalendario());
  document.getElementById('mapTooltipClose')?.addEventListener('click', ()=>calendario.cerrarTooltipMapa());
  document.getElementById('mapTooltipCloseBtn')?.addEventListener('click', ()=>calendario.cerrarTooltipMapa());
  calendario.cerrarTooltipMapa = function(){ document.getElementById('mapTooltip').style.display='none'; };

  // Gesti√≥n hist√≥rico
  document.getElementById('btnGestionHistorico')?.addEventListener('click', ()=>{
    calendario._rellenarSelectHistorico();
    document.getElementById('historicoDias').value='';
    document.getElementById('historicoOverlay').style.display='flex';
    calendario._pintarHistoricoLista();
  });
  document.getElementById('historicoClose')?.addEventListener('click', ()=>{ document.getElementById('historicoOverlay').style.display='none'; });
  document.getElementById('historicoCancelar')?.addEventListener('click', ()=>{ document.getElementById('historicoOverlay').style.display='none'; });
  document.getElementById('historicoGuardar')?.addEventListener('click', ()=>{
    const pais = document.getElementById('historicoPais').value;
    const dias = parseInt(document.getElementById('historicoDias').value||'0');
    if(!pais){ alert('Selecciona un pa√≠s'); return; }
    if(isNaN(dias) || dias<0){ alert('Introduce d√≠as v√°lidos'); return; }
    const idx = calendario.historico.findIndex(x=>x.pais===pais);
    if(idx===-1) calendario.historico.push({pais, dias}); else calendario.historico[idx].dias=dias;
    calendario.guardarHistorico();
    calendario._pintarHistoricoLista();
    calendario.pintarMapa?.();
  });
})();

// === Export/Import: a√±adir hist√≥rico ===
(function(){
  // Parche exportarDatos
  const _export = calendario.exportarDatos?.bind(calendario);
  if(_export){
    calendario.exportarDatos = function(){
      try{
        const datos={
          vacaciones:[...this.vacacionesPersonales],
          viajes:this.viajes,
          historico:this.historico, // <-- a√±adido
          fechaExportacion:new Date().toISOString(),
          totalViajes:this.viajes.length,
          totalVacaciones:this.vacacionesPersonales.size,
          version:'1.1', tipo:'Calendario Torres de Elorz 2026'
        };
        const s=JSON.stringify(datos,null,2); const fecha=new Date().toISOString().split('T')[0];
        this.mostrarModalExportacion(s,fecha);
      }catch(e){ alert('‚ùå Error al exportar datos: '+e.message); }
    }
  }

  // Parche importarDatos (desde archivo)
  const fileInput = document.getElementById('fileImport');
  if(fileInput){
    // Ya existe un handler original; lo respetamos porque se reasigna dentro
  }

  // Hook de funciones internas ya existentes
  const _importarDesdeArchivo = calendario.importarDatos?.bind(calendario);
  if(_importarDesdeArchivo){
    calendario.importarDatos = function(ev){
      const prev = ev && ev.target && ev.target.files && ev.target.files[0];
      const originalOnLoad = (e)=>{ /* no usado aqu√≠ */ };
      // Dejamos que corra el original y luego a√±adimos hist√≥rico si existe
      const oldPush = this.guardarViajes.bind(this);
      const self=this;
      const reader = new FileReader();
      const f = ev.target.files[0]; if(!f) return; ev.target.value='';
      reader.onload = (e)=>{
        try{
          const datos = JSON.parse(e.target.result);
          if(datos.historico && Array.isArray(datos.historico)){
            // Validar forma {pais, dias}
            self.historico = datos.historico.filter(h=>h && h.pais && Number.isFinite(parseInt(h.dias)));
            self.guardarHistorico();
          }
        }catch(err){ console.warn('Hist√≥rico no presente o inv√°lido:', err); }
      };
      reader.readAsText(f);
      // Ejecutar original tambi√©n
      _importarDesdeArchivo(ev);
    }
  }

  // Parche procesarImportacionIOS (pegado)
  if(calendario.procesarImportacionIOS){
    const _ios = calendario.procesarImportacionIOS.bind(calendario);
    calendario.procesarImportacionIOS = function(){
      const txt = document.getElementById('iosImportTextarea').value.trim();
      try{ const datos = JSON.parse(txt); if(datos.historico && Array.isArray(datos.historico)){
        this.historico = datos.historico.filter(h=>h && h.pais && Number.isFinite(parseInt(h.dias)));
        this.guardarHistorico();
      }}catch(e){ /* ya lo maneja el original */ }
      return _ios();
    }
  }
})();
let calendario;
        document.addEventListener('DOMContentLoaded', () => {
            calendario = new CalendarioViajes();
        });
    </script>

<!-- VISTA MAPA MUNDIAL -->
<div class="viajes-container" id="vistaMapa" style="display:none;">
  <div class="viajes-header">
    <button class="volver-calendario" id="volverDesdeMapa">‚Üê Volver</button>
    <h2>üåç Mapa mundial de viajes</h2>
    <div></div>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
    <button class="btn-nuevo-viaje" id="btnGestionHistorico" style="background:linear-gradient(135deg,#9C27B0 0%,#7B1FA2 100%);flex:1;min-width:220px;">üìù Gestionar hist√≥rico (antes de 2026)</button>
  </div>

  <div id="mapaContainer" style="width:100%;">
    <div id="mapaSvgWrapper" style="width:100%;"></div>
    <div style="text-align:center;color:#888;font-size:12px;margin-top:6px;">Toca un pa√≠s para ver detalles</div>
  </div>
</div>

<!-- Popup mapa -->
<div class="day-info-overlay" id="mapTooltip" style="display:none;">
  <div class="day-info-content">
    <div class="day-info-header">
      <div class="day-info-title" id="mapTooltipTitle">Pa√≠s</div>
      <button class="close-day-info" id="mapTooltipClose">&times;</button>
    </div>
    <div class="day-info-body" id="mapTooltipBody"></div>
    <div class="form-botones"><button class="btn-cancelar" id="mapTooltipCloseBtn">Cerrar</button></div>
  </div>
</div>

<!-- Modal gesti√≥n hist√≥rico -->
<div class="day-info-overlay" id="historicoOverlay" style="display:none;">
  <div class="day-info-content" style="max-width:520px;">
    <div class="day-info-header">
      <div class="day-info-title">üìù Hist√≥rico de viajes (antes de 2026)</div>
      <button class="close-day-info" id="historicoClose">&times;</button>
    </div>
    <div class="day-info-body">
      <div class="form-group">
        <label class="form-label" for="historicoPais">üåç Pa√≠s</label>
        <select class="form-select" id="historicoPais"></select>
      </div>
      <div class="form-group">
        <label class="form-label" for="historicoDias">üìÜ D√≠as totales (antes de 2026)</label>
        <input type="number" min="0" class="form-input" id="historicoDias" placeholder="Ej: 12">
      </div>
      <div class="form-botones">
        <button class="btn-guardar" id="historicoGuardar">Guardar</button>
        <button class="btn-cancelar" id="historicoCancelar">Cancelar</button>
      </div>
      <h3 style="margin-top:18px;color:#333;">Listado</h3>
      <div id="historicoLista" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

  <script src="./world/mapa.js"></script>
</body>
</html>
